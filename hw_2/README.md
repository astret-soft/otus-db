# Добавляем в модель данных дополнительные индексы и ограничения

1. Проводим анализ возможных запросов\отчетов\поиска данных.
2. Предполагаем возможную кардинальность поля.
3. Создаем дополнительные индексы - простые или композитные.
4. На каждый индекс пишем краткое описание зачем он нужен (почему по этому полю\полям).

5. Думаем какие логические ограничения в БД нужно добавить - например какие поля должны быть уникальны, в какие нужно добавить условия, чтобы не нарушить бизнес логику. Пример - нельзя провести операцию по переводу средств на отрицательную сумму.
6. Создаем ограничения по выбранным полям.
Критерии оценки: 5 - задача выполнена
4 - задача выполнена но есть претензии


# Анализ возможных запросов, отчетов, поиска данных
## **Для всех отношений (многие к многим, один к одному и т.д.) нужно предоставить для foreign key индексацию для осуществления большей доступности по времени запросов SELECT, так же не рассматриваю сущности, где нужны композитные индексы (на пример пара (username, password_hash) требует комплексной индексации для более быстрой авторизации), где нужно (не включаю FK* поля с их обьяснением, как указано в схеме).**
Для администратора и пользователя с правами администрировать сцену будут интересны данные запросы (также их редактирование и создание через CREATE, UPDATE, INSERT):
* Какие пользователи обладают следующими привилегиями (правами)
* Кто есть из пользователей на схеме
* Какие пользователи использовали определенные методы для определения свей локации на схеме (их популярность)
* Поиск сцены по описанию (поле description через FTS)
Пользователь не использует какой-либо функционал, кроме базового (авторизация, получения себя на сцене или добавления к ней, получение текущего кадра), поэтому для них необходимо предоставить следующие запросы:
* 
# Индексы и ограничения
First Header | Second Header | 1 | 2
------------ | ------------- | ------------ | -------------
1 | 2 | 3 | 4wrewrfrwrwrwrwrwr
# 


Сцена - это достаточно большое место с достаточным числом пользователй (пикселей), где есть возможность обозревать пользователей визуально как экран.
Данный сервис предоставляет пользователям возможность обьединятся в сцены в целях показа изображения или анимации (видео),
используя множество телефонов или иных носимых устройств (планшетов или других специализированных устройств) как пиксель на большой сцене.
## Схема
![Schema](entities.svg)
> ### Сущности:
> * User - пользователь данного сервиса
> * Permissions - права пользователя, к приверу: быть пикселем в сцене, наблюдатель для определения координат на сцене других пользователей, право на исключения пользователя из сцены, etc
> * Method - метод, который используется для локации каждого пикселя в конкретной сцене: QR-code, визуальное обнаружения, GPS, звуковое, etc
> * Pixel - связь между пользователем и его отобраением на опреленной сцене
> * Scene - сцена, в которой обьедены пользователи в целях некотрого действия для показа кадра или серии кадров
> * Frame - кадр, изображение, которое необходимо воспроизвести, используя сцену из пикселей

> ### Связи:
> Имеем следующие связи многие к многим:
> * Права к пользователям, реализованную через сущность User permission
> * Сцена к пользователю, реализованная через сущность Pixel
> Один к многим:
> * Используемый метод к сцене
> * Кадры в сцене
> Один к одному:
> * Изображений кадра image_id к файлу в MongoDB GridFS

В качестве основной БД предполагается использовать БД PostgreSQL, т.к. выбранные сущности и связи между ними отвечают формату SQL. В качестве хранения небольших файлов-изображений выбрана база MongoDB, а именно решение GridFS для хранения файлов и их метаинформации. 
## Примеры бизнес-задач которые решает база
* Хранение информации о пользователях: их личную информацию, права, хэш пароля и тд
* Хранение общей информации о сцене, воспроизводимых кадров на ней и пользователей (пикселей)
## Рекомендации к использованию репликации
Для PostgreSQL рекомендуется использовать стандартный механизм через WAL -  мастера к репликам (2 и более).
Для MongoDB GridFS - это Replica Set c мастером и двумя репликами.
## Рекомендации к резервному копированию
Предполагется полное резервное копирование обеих БД по крон-заданию во время часов планового обслуживания, проводя бэкапирвоание на одной из реплик, предварительно ее отключив от ноды:
* pg_dump - для создания бэкапа PostgreSQL
* mongodump - для оздания бэкапа MongoDB
